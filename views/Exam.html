<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Page</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
  

  <div class="exam-container">
    <h2 class="form-title">Online Exam</h2>
    <div class="input-group">
      <label for="subjectSelect">Select Subject:</label>
      <select id="subjectSelect"></select>
    </div>
    <div class="input-group">
      <label for="chapterSelect">Select Chapter:</label>
      <select id="chapterSelect"></select>
    </div>
    <button id="startExamBtn">Start Exam</button>
    <div id="timer" class="timer-box" style="display:none;">Time Left: 10:00</div>

    <div id="exam-container"></div>

    <div class="nav-buttons" style="display:none;">
      <button id="prevBtn">Previous</button>
      <button id="submitExam">Submit Exam</button>
      <button id="nextBtn">Next</button>
    </div>

    <div id="resultBox" style="margin-top:20px; display:none;">
      <h3>Result</h3>
      <p id="resultText"></p>
    </div>
  </div>

  

<script>
let questions = [];
let userAnswers = {};
let currentPage = 0;
const perPage = 10;
let timerInterval;
let examStarted = false;
let examSubmitted = false;
let timeLeft = 600;
let selectedSubject = '';
let selectedChapter = '';
let userClassLevel = '';
let availableSubjects = []; // To store subjects once loaded

const examContainer = document.getElementById("exam-container");
const navButtons = document.querySelector(".nav-buttons");
const timerDisplay = document.getElementById("timer");
const subjectSelect = document.getElementById('subjectSelect');
const chapterSelect = document.getElementById('chapterSelect');

// Load subjects for the current user's class level
async function loadSubjectsForExam() {
  try {
    const authRes = await fetch('/api/check-auth');
    const authData = await authRes.json();
    
    if (!authData.loggedIn) {
        alert("Please log in to take the exam.");
        document.querySelector('.exam-container').innerHTML = '<p>Please <a href="/login">log in</a> to take the exam.</p>';
        return;
    }

    const user = authData.user;
    userClassLevel = user.classLevel.toString();

    const res = await fetch(`/api/student/subjects?classLevel=${user.classLevel}`);
    availableSubjects = await res.json(); // Store subjects

    if (availableSubjects.length === 0) {
        subjectSelect.innerHTML = '<option value="">No subjects approved yet</option>';
        chapterSelect.innerHTML = '<option value="">-</option>';
        document.getElementById('startExamBtn').disabled = true;
        document.getElementById('startExamBtn').textContent = 'Contact an admin for subject approval';
        return;
    }

    subjectSelect.innerHTML = '<option value="">Select Subject</option>';
    availableSubjects.forEach(subject => {
      const option = document.createElement('option');
      option.value = subject.name;
      option.textContent = subject.name;
      subjectSelect.appendChild(option);
    });

    subjectSelect.addEventListener('change', () => {
      selectedSubject = subjectSelect.value;
      loadChaptersForExam(selectedSubject);
    });

  } catch (err) {
    console.error("Failed to load subjects for exam:", err);
  }
}

// Load chapters for the selected subject from already loaded subjects
function loadChaptersForExam(subjectName) {
  chapterSelect.innerHTML = '<option value="">Select Chapter (Optional)</option>';
  const subjects = availableSubjects.filter(s => s.name === subjectName);

  if (subjects.length > 0) {
    let allChapters = [];
    subjects.forEach(subject => {
        const classData = subject.classes.find(c => c.classLevel === userClassLevel);
        if (classData && classData.chapters) {
            allChapters.push(...classData.chapters);
        }
    });
    
    const uniqueChapters = [...new Set(allChapters)];
    uniqueChapters.forEach(chapter => {
        const option = document.createElement('option');
        option.value = chapter;
        option.textContent = chapter;
        chapterSelect.appendChild(option);
    });
  }
  chapterSelect.addEventListener('change', () => {
    selectedChapter = chapterSelect.value;
  });
}

// Initial load
loadSubjectsForExam();

function renderQuestions(questionList) {
  examContainer.innerHTML = questionList.map((q, i) => `
    <div class="question-block">
      <p><b>Q${i + 1}:</b> ${q.questionText}</p>
      ${q.options.map((option, index) => `
        <label><input type="radio" name="q${q._id}" value="option${index + 1}"> ${option}</label><br>
      `).join('')}
    </div>
  `).join("");

  questionList.forEach(q => {
    if(userAnswers[q._id]) {
      const input = document.querySelector(`input[name="q${q._id}"][value="${userAnswers[q._id]}"]`);
      if(input) input.checked = true;
    }
  });

  document.querySelectorAll('input[type="radio"]').forEach(input => {
    input.addEventListener('change', function() {
      userAnswers[this.name.replace('q','')] = this.value;
    });
  });
}

function showPage(page) {
  if (questions.length === 0) { examContainer.innerHTML = "<p>No questions available.</p>"; return; }
  const start = page * perPage;
  const end = start + perPage;
  renderQuestions(questions.slice(start, end));
}

document.getElementById("prevBtn").addEventListener("click", () => {
  if (!examStarted) { alert("⚠️ Start the exam before"); return; }
  if (currentPage > 0) { currentPage--; showPage(currentPage); }
});

document.getElementById("nextBtn").addEventListener("click", () => {
  if (!examStarted) { alert("⚠️ Start the exam before"); return; }
  if ((currentPage + 1) * perPage < questions.length) { currentPage++; showPage(currentPage); }
});

document.getElementById("startExamBtn").addEventListener("click", async () => {
  selectedSubject = subjectSelect.value;
  if (!selectedSubject) {
    alert("Please select a subject to start the exam.");
    return;
  }

  try {
    const startRes = await fetch('/api/start-exam', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subjectName: selectedSubject, chapterName: selectedChapter })
    });
    const startData = await startRes.json();
    if (!startData.success) { alert(startData.message); return; }

    questions = startData.questions;

    if (questions.length === 0) {
      alert("No questions found for the selected subject and chapter.");
      return;
    }

    examStarted = true;
    examSubmitted = false;
    document.getElementById("startExamBtn").style.display = "none";
    subjectSelect.disabled = true;
    chapterSelect.disabled = true;
    timerDisplay.style.display = "block";
    navButtons.style.display = "flex";
    currentPage = 0;
    showPage(currentPage);

    timeLeft = Math.floor((startData.expiryTime - Date.now()) / 1000);
    if(timeLeft <= 0) timeLeft = 0;
    startTimer();
  } catch (err) { console.error(err); }
});

function startTimer() {
  clearInterval(timerInterval);
  function updateTimer() {
    if(examSubmitted) return;
    if(timeLeft <= 0) {
      clearInterval(timerInterval);
      let countdown = 5;
      timerDisplay.textContent = `⏰ Time is over! Submitting in ${countdown}s`;
      const countdownInterval = setInterval(() => {
        countdown--;
        if(countdown >= 0) timerDisplay.textContent = `⏰ Time is over! Submitting in ${countdown}s`;
        if(countdown <= 0) {
          clearInterval(countdownInterval);
          submitExam();
        }
      }, 1000);
      return;
    }
    let minutes = Math.floor(timeLeft / 60);
    let seconds = timeLeft % 60;
    timerDisplay.textContent = `Time Left: ${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
    timeLeft--;
  }
  updateTimer();
  timerInterval = setInterval(updateTimer, 1000);
}

async function submitExam() {
  if(!examStarted || examSubmitted) return;
  examSubmitted = true;
  clearInterval(timerInterval);

  const answers = questions.map(q => ({
    questionId: q._id,
    selectedOption: userAnswers[q._id] || null
  }));

  try {
    const res = await fetch('/api/submit-result', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answers, subjectName: selectedSubject, chapterName: selectedChapter })
    });
    const data = await res.json();
    if(data.success) {
      // redirect to profile page
      window.location.href = "/profile";
    } else {
      alert(data.message || "❌ Exam submit failed");
    }
  } catch(err) { console.error(err); }
}

document.getElementById("submitExam").addEventListener("click", submitExam);

// Prevent leaving page without submit
window.addEventListener("beforeunload", function(e) {
  if(examStarted && !examSubmitted) {
    e.preventDefault();
    e.returnValue = "⚠️ You have not submitted your exam yet. Are you sure you want to leave?";
  }
});

document.querySelectorAll('a').forEach(link => {
  link.addEventListener('click', function(e) {
    if(examStarted && !examSubmitted) {
      e.preventDefault();
      alert("⚠️ Please submit your exam before leaving the page!");
    }
  });
});

// Show admin link
fetch('/api/check-auth').then(res => res.json()).then(data => {
  if(data.loggedIn && data.user.role === "admin") {
    document.getElementById("adminLink").style.display = "inline-block";
  }
});
</script>
</body>
</html>
